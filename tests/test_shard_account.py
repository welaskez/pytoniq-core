from pytoniq_core import Cell, Builder
from pytoniq_core.tlb.account import Account, ShardAccount
import os

def test_account_regular():
    account = Cell.one_from_boc('b5ee9c720101030100a900026dc00f5f09760a78c84bab1153c4876ebde53f17942190f54b21c2d132a1d416259da20680ec433fbf6d600000cb7102293d0cd6ae72d34001020842028f452d7a4dfd74066b682365177259ed05734435be76b5fd4bd5d8af2b7c3d6800910505d1bf1f408006c0b20d2e4980a9656da6117470d08956a955da832f6167ccad80c1f9782e451002c44ea652d4092859c67da44e4ca3add6565b0e2897d640a2c51bfb370d8877fa')
    deserialized = Account.deserialize(account.begin_parse())

    assert deserialized.serialize().hash == account.hash


def test_storage_frozen():
    account = Cell.one_from_boc('b5ee9c7201010101005a0000afcff7294428f130c71b08e164eadbc699145b14eb4301dfd9f92ea6ca73ea0d7a27d2028051c33a4dd8852afb386a80000bae23276780c0e22a3ad11cd49d7c209be8e3badc53112b881c298c42242ca1917a56dac8d0b140')
    deserialized = Account.deserialize(account.begin_parse())

    assert deserialized.storage.state.type_ == "account_frozen"
    assert deserialized.serialize().hash == account.hash

def test_shard_account_regular():
    last_trans_hash = bytes(range(32))
    last_trans_lt = 1234
    assert len(last_trans_hash) == 32

    account = Cell.one_from_boc('b5ee9c7201010101005a0000afcff7294428f130c71b08e164eadbc699145b14eb4301dfd9f92ea6ca73ea0d7a27d2028051c33a4dd8852afb386a80000bae23276780c0e22a3ad11cd49d7c209be8e3badc53112b881c298c42242ca1917a56dac8d0b140')
    shard_account = Builder() \
        .store_ref(account) \
        .store_bytes(last_trans_hash) \
        .store_uint(last_trans_lt, 64)
    
    serialized = shard_account.end_cell()
    deserialized = ShardAccount.deserialize(serialized.begin_parse())
    serialized_using_shard_account = deserialized.serialize()

    assert deserialized.last_trans_hash == last_trans_hash
    assert deserialized.last_trans_lt == last_trans_lt
    assert deserialized.account.serialize().hash == account.hash
    assert serialized_using_shard_account.hash == serialized.hash


def test_account_storage_with_dict():
    acc_cell = Cell.one_from_boc('b5ee9c7201023201000b3d0002a7c00d2fa357369d77da4f57417e3a5648a390886268c572ad6b3cffc53ca3dd5896726494994fef873bef300f673febc5f70a3cabe628bfa1bf669d864478142b76b9fc3c70f3412d192000007e014c0d311c134001020114ff00f4a413f4bcf2c80b0303238000000000000000000000000000000000012f303102016204050202cc06070201202b2c020120080902012026270201200a0b02012022230201200c0d020120202104913b68bb7ec07434c0fe900c08b5d27087e4c0b4c7e4c09c0078809c6c2497c1780820840208b62baeb8c0bc00882084167688066eb8c088208424ffe734eeb8c08820840af1a7102ea00e0f101101f7208054602082784ce020840e1b50e014cc2e7cb432544ce848208602ae166d802fbcb43294c06a41082ac06920820a37a02082093a8008ea4e007000264c2082098ee000a940b7a0820a37a0208209e34020820a37a0208209e34020820a37a020820a37a0208209e34020820a37a0208209e3400320820a37a003e01e00cc306c22d33fd3ffd401d0fa40d3ff3002d401d0fa40fa403002d211d31f2282015180be238206ae80bbb1f2d0ffed44d0d20001f2d0ffd3ff5119baf2e0fffa405116c705f2e0fffa405117c705f2e0ffd1106710354777f004830682108137549a5a7001f00500d830d33ffa00fa005340d749c2009430fa4001def844f845a0f846a1f847a1705191a15008a1f82ca118b6095163a022a05006a0f82fa070fb02f848c303f2e06620c000f84d15c70514b1f2e064102481008282109f7df4805a705006f005f84401a0f864f84501a0f865f00301fe30f84a5220c705f2e064d33fd401d0d3ffd31fd31ffa00fa00fa00fa00d200d31f3009d31ff84e500abaf2e0ff078210415d8ae0baf2e0fff848c303f2e066f8415260bcf2e065f8515290be29f823bbb0f2e065f8465230bef2e065f8475220bef2e065f8425250bef2e065f8435240bef2e065f84424a025a123a1f845261204b6e302208210b5526345ba8e33306c22d33f5302f00601d3ffd31fd31f30f84e5003baf2e0ff8210f1cfd9dfbaf2e0fff848c303f2e066f841baf2e06559f00de020820a3cd52cbae302208210ba2c493abae30220821074eb9429ba18191a1b02f8a025a123a1228e1421c200965044a0037001de20c2009413a00270dede01c2fff2e065c2fff2e065f844f845a0f846a1f847a17051e1a1500da1f82ca11db609f8465230a11ca1f8475220a1a1500ba0f82fa070fb02f8465210bc8e13f84c7282108160cbebf8465240a1546ba1f005def84752a0bce3001028830613140026f84d7182108160cbebf84752d0a1546ba1f00502628210b2c27dea5a19705008f00501db3cf84252e0bc925f09e30d01f86604f86702f862f86301f861f8719373f868def003151601f4f84fd0fa00fa00fa00fa00fa00d31fd31fd31ff404305391bd8e5853908020f40f6fa18e3e3236363604d0fa00fa00fa00d31f3030258020f4866fa53291018e155309bb9852078020f45b3006de268020f47c6fa532e830547210547769547debf00a993039f2c06946785025e210584765129139e2107810671700caf84252e0a129c200531abcb0f2d067534cb98e1a343570f85252c0a12082015180a908a182015180a0f852a05064de5166a028c200965308bcf2d067de533cb98e10333470f85252c0a1f00131f852a05053de5056a026c200965306bcf2d067de5044f00a0010105610451034413001fe306c22f84c5220c705f2e064f82ff82ca074fb02d33ffa00fa00fa00d31f23c3005354bcb023c3005354bcb0b1f2d0fff84fd0fa00fa00fa00fa00fa00d31fd31fd31ff4043053a1bbf2d0ff206eb38e1e208020f48f6fa53031218020f4876fa5303153c1bbf2d0ffa1c203f2d068de4dcb2af00940898020f417104810371c00803033f84c5210c705f2e06401820afaf080b9f2d0ff01d33fd4d401d020d7498308baf2e0ff22f900f84b12f910f2e06401fb04804082108b2959185a7001f00500ae306c22f84c58c705f2e064f82ff82ca074fb02d33ffa40fa00f404307082100f8a7ea5c8cb1f15cb3f58fa02f84ccf16f84ccf16f40070fa0212ca00c971708018c8cb055004cf1623fa0213cb6912cb00ccc98306fb0001708e2c306c22f84c22c705f2e064f844f845a0f846a1f847a1f82fa070fb028306821079e42088702010344013f005e0c000e3025f04f2c0ff1d003046501034439012f00af0038306821026c928e15a7001f00500ee20d749c0288e20d327018218436c6f7365ba8e126c22f84c5220c705f2e064705202f00ddb31e0de22821005f5e100a120c101f2d0fff844f845a0f846a1f847a1705161a15005a1f82ca115b6095134a05003a0f82fa070fb02f848c303f2e066830682109f7df48070205504f005f84401a0f864f00301e2a850bfa81ea051bba170547919be8ed45b28a13826820828de805398be8ebf315187a1265098a05386be8ea9375175a1245076a05364be8e94355153a1225054a05342be953b5b375f05e30d1295105c3b5f09e212963d5f06355f03e2129450ed5f0ce29450ef5f0de213a058a05202a01f00ee335131a1544330a05323be8e63315112a1235023a05313be8e4f3222a1235023a05313be8e3b3222a1275023a05317be8e273226a1225027a05312be8e163621a1544260a05352be3605943013a002923330e21293355f03e2951027365f04e212953830355f03e212951029385f06e29450a95f08e21200d13b51343480007cb83ff4c7c07e1874c7c07e1c7484407e1cbe80007e18be80007e18fe80007e193e80007e197e80007e19be80007e19f4c0c07e1a34c7c07e1a7500743e90007e1ab4ffcc3e1af5007434ffc07e1bbe90007e1b3e90007e1b74c7cc3e1cf50c3e1be000a93e13fe14fe13b232fffe1333c5be1373c5b2c7f27e12f23e12b3c5b2fff27e127e123e14be147e105ff2328032c7f2c7f2847e10be80be10fe80be113e80be117e80be11be80be11fe80b2c0f2c7f33333327b55200201202425005f401d200018e10d30021c001f2e064f84a13c705f2e064e0d30021c00098f84c13c705f2e06498f84d13c705f2e064e2800c51b5c14c032087e80887e80887e80887e80887e80b2c7f2c7f2c7fd003241f232ffd401b3c5940133c58532c7f2721633c584f2fff25c151c001ff2328032c7f2c7c53284487e80887e80887e80887e80887e80887e8084f2c0c4b2c7f33333327b552000391c20043232c15401f3c5963e808572da84b2c7f2cfd633c5b2407ec020020120282901d165c3e12300067cc08b000263e08fe126f3cb819779fe38508f00025fe08fe14e83e1a65c8f000648c1ff7b8b88838c0082384440920c1a0841cfd6df716859c1401fc0163844409201020841cfd6df716859c1401fc017880650c1cfe1a25f00024dc7e1a37b8bc00e2a001d5c85004fa0258fa0201fa02cb1fc98003f4c85009fa025007fa025005fa025003fa0201fa02cb1fcb1fcb1ff400c9f86f800a2f844f843a0f842a1f846a1f845f842a0f843a1f847a121c2008e16f84622a0f866f84c725882108160cbeb54207527f0059131e220c2008e15f84721a0f867f84d735882108160cbeb526226f0059130e20201202d2e0011bc62df6a2686900184004dbaf15f002f848f841f851f84ef844f846f842f84cf84af845f847f843f84df84ff852f853f8498001fb80a9f002f844f845a0f846a1f847a180083801a56dc49a0f617b1c1d5b3c83b9621b1abc785cd10f880c8b5d14c644a443c04069a752dbb3870b9b98eea82bcdc07df867df6c5e8e07860e1ece57c2d43e5a53000cdbc5088bfaeddb01891abf055205b292fb567a1ae24c6deaafb6564b260939163801cfc02752e197da18e7bb968d7a55a4377a4b39a314620a75b13778c7260108bf002bbcd443ad8fdcaf8302c5f1556c663319b6561a143b5a5ea20edb340720ec75400003842001d000000000000000000000000000004')

    acc = Account.deserialize(acc_cell.begin_parse())
    assert acc.storage_stat.storage_extra.dict_hash == b'\xfd\xf0\xe7}\xe6\x01\xec\xe7\xfdx\xbe\xe1G\x95|\xc5\x17\xf47\xec\xd3\xb0\xc8\x8f\x02\x85n\xd7?\x87\x8e\x1e'
    assert acc.serialize().hash == acc_cell.hash

